# Java零拷贝学习笔记

转载请声明！！！侵权必究。本文如有错误，欢迎指正。

> 参考资料：
>
> - 《Java高并发核心编程卷一》
> - https://blog.csdn.net/weixin_39406430/article/details/123715072
> - https://zhuanlan.zhihu.com/p/308054212
> - 《葵花宝典》尼恩

## 一、IO读写原理

### 1.1 内核态、用户态、内核空间、用户空间

为了避免用户进程直接操作内核，操作系统将内存分为内核空间和用户空间。在Linux中内核模块运行在内核空间，对应的进程处于内核态，用户程序运行在用户空间，对应的进程处于用户态。也可以理解为当进程运行在内核空间时就处于**内核态**，当进程运行在用户空间时就处于**用户态**。内核态进程可以执行任何命令调用一切资源，而用户态进程只能执行简单的运算，不能直接调用系统资源。**如果用户态进程需要调用系统资源，就需要调用系统接口进行系统调用，才能向内核发出指令，完成系统资源的调用。**

> 用户态切换内核态的方式：
>
> - **系统调用**：用户进程主动发起的操作。用户态进程发起系统调用主动要求切换到内核态，陷入内核之后，由操作系统来操作系统资源，完成之后再返回到进程。
> - **异常**：被动的操作，且用户进程无法预测其发生的时机。当用户进程在运行期间发生了异常（比如某条指令出了问题），这时会触发由当前运行进程切换到处理此异常的内核相关进程中，也即是切换到了内核态。异常包括程序运算引起的各种错误如除 0、缓冲区溢出、缺页等。
> - **中断**：当外围设备完成用户请求的操作后，会向 CPU 发出相应的中断信号，这时 CPU 会暂停执行下一条即将要执行的指令而转到与中断信号对应的处理程序去执行，如果前面执行的指令是用户态下的程序，那么转换的过程自然就会是从用户态到内核态的切换。中断包括 I/O 中断、外部信号中断、各种定时器引起的时钟中断等。中断和异常类似，都是通过中断向量表来找到相应的处理程序进行处理。区别在于，中断来自处理器外部，不是由任何一条专门的指令造成，而异常是执行当前指令的结果。

内核是操作系统的核心，它可以访问受保护的内核空间，也可以访问底层硬件设备。内核空间是操作系统为内核保留的，它总是驻留在内存中，应用程序不允许直接在内核空间区域进行读写，也不允许直接调用内核代码定义函数。每个应用程序进程都有一个单独的用户空间，对应于进程处于用户态，进行系统调用时，需要将进程切换到内核态。

### 1.2 内核缓冲区和进程缓冲区

当用户程序进行IO读写时，实际上依赖于底层的IO读写，也就是会用到底层的read和write系统调用（不同操作系统可能名称不同）。操作系统的read系统调用并不是从物理设备将数据读取到应用内存中，write系统调用也是如此，无论是哪个系统调用都设计到缓冲区，也就是说read系统调用时，实际上是将数据从内核缓冲区复制到应用程序的进程缓冲区中，write系统调用是将数据从应用程序的进程缓冲区复制到操作系统的内核缓冲区中。简单理解就是，read和write系统调用实际上是缓存的复制。而底层与物理设备的读写操作由内核完成。

那么设置缓冲区的作用是什么？其实是为了减少与设备间的频繁的物理交换。计算机外部物理设备与内存和CPU相比有很大区别，外部设备读写需要涉及到操作系统的中断。系统中断时需要保存中断前的相关信息，中断后还需要进行恢复。因此为了减少频繁的中断于是有了内核缓冲区。这样就可以等到缓冲区到达一定数量在集中进行IO操作，提升性能，这一切都由内核决定。在Linux系统中，只有一个内核缓冲区。

### 1.3 C程序的IO

> DMA 全称是 Direct Memory Access，也即直接存储器存取，是一种用来提供在外设和存储器之间或者存储器和存储器之间的高速数据传输。整个过程无须 CPU 参与，数据直接通过 DMA 控制器进行快速地移动拷贝，节省 CPU 的资源去做其他工作。
>
> 目前，大部分的计算机都配备了 DMA 控制器，而 DMA 技术也支持大部分的外设和存储器。借助于 DMA 机制，计算机的 I/O 过程就能更加高效。

### 1.4 Java程序的IO

## 二、零拷贝



### 2.1 DirectBuffer



### 2.2 mmap+write

mmap将一个文件或者其它对象映射进内存。文件被映射到多个页上，如果文件的大小不是所有页的大小之和，最后一个页不被使用的空间将会清零。mmap在用户空间映射调用系统中作用很大。

### 2.3 sendfile



## 三、NIO文件传输
