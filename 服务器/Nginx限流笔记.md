# 限流算法和原理

在通信领域，限流被用来控制网络接口收发通信数据的速率，实现通信时的优化性能、较少延迟和提高带宽的功能。

互联网领域借鉴了此概念，用于控制高并发、大流量到来时对服务接口的请求的速率，比如618、双十一、抢票等活动。比如某个接口能抗住10000的QPS（每秒的响应请求数，也即是最大吞吐能力，QPS = 并发量 / 平均响应时间），但是突然来了15000个请求，那么这时候我们可以对请求进行限制，比如先放进来10000个请求，让其他请求阻塞一段时间，而不是直接返回404，让客户端等一会在重试，起到了流量削峰的作用。接口限流的算法主要有三种，分别是计数器限流、漏桶算法和令牌桶算法。

## 一、限流算法和简单实现

### 1.1 计数器限流

计数器限流原理十分简单，即在一个时间窗口内，所请求的最大数量是有限制的，对超出限制的部分请求不做处理。

计数器限流分为固定和滑动窗口两种：

1. 固定窗口就是每一分钟或者每一秒中的请求不能超过阈值，在下一秒钟计数器清零，重新进行计算

   ![image-20220701102338752](https://mypic-12138.oss-cn-beijing.aliyuncs.com/blog/picgo/image-20220701102338752.png)

   但是固定窗口的计数器限流可能会存在流量突刺，比如在一分钟的第59秒有100个请求进来了，这时刚好没超过阈值，可以通过。但是第二分钟的第一秒又来了100个请求，因为count计数器清0了，所以这时又能通过，这样短时间内实际上通过了200个请求。

2. 滑动窗口就是细分后的计数器，他将每个时间窗口细分成若干个时间片段，每过一个时间段，整个时间窗口就会向右移动一格。

   ![image-20220701102839189](https://mypic-12138.oss-cn-beijing.aliyuncs.com/blog/picgo/image-20220701102839189.png)

   如上图，时间窗口划分的越细比如5s、10s，限流效果就会越精细，滑动效果就会越平滑。

### 1.2 漏桶限流

漏桶大小固定、处理速率固定，但请求进入的速度不固定。如果出现突发情况，可能会丢弃过多请求。

这个算法其实很形象，它就类似一个限制出水的水桶，通过一个固定大小的FIFO队列+定时队列元素的方式实现，请求进入队列后会被匀速的取出来，当队列被占满后新的请求就会直接拒绝，就像水从水桶中漏出来一样。这个算法优缺点也很明显，优点是请求匀速发给后端，不会造成流量突刺，缺点是请求会在队列中排队，响应时间会很长。



### 1.3 令牌桶限流

令牌桶的大小固定，令牌的产生速度固定，但是消耗令牌（请求）的速度不固定（可以应对某些时间请求过多的情况）。每个请求都会从令牌桶中取出令牌，如果没有令牌， 就丢弃这次请求。

令牌桶的优点是可以应对突发流量，当桶里有令牌时请求可以快速的响应，也不会产生漏桶队列中的等待时间, 缺点就是相对漏桶一定程度上减小了对下游服务的保护。

![image-20220701103914036](https://mypic-12138.oss-cn-beijing.aliyuncs.com/blog/picgo/image-20220701103914036.png)

## 二、分布式计数器限流



## 三、Nginx漏桶限流



## 四、分布式令牌桶限流

